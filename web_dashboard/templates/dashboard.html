{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 rounded">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{{ url_for('dashboard') }}">ðŸ’¾ Dashboard</a>
    <div class="d-flex align-items-center">
      <span class="navbar-text me-3">
        Logged in as: <strong>{{ session.user_email }}</strong>
      </span>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Logout</a>
    </div>
  </div>
</nav>

<div class="row">

  <div class="col-md-4">
    <div class="card bg-dark text-white mb-4">
      <div class="card-header fw-bold">Scan Controls</div>
      <div class="card-body">
        <form id="scan-form">
          <div class="mb-3">
            <label for="target_ip" class="form-label">Target IP Address</label>
            <input type="text" class="form-control" id="target_ip" name="target_ip" placeholder="e.g., 192.168.1.1" required>
          </div>
          <button type="submit" id="scan-button" class="btn btn-primary w-100">Start Scan</button>
        </form>
        <div id="scan-status" class="mt-3"></div>
      </div>
    </div>
    <div class="card bg-dark text-white">
      <div class="card-header fw-bold">Scan History</div>
      <div class="list-group list-group-flush">
        {% if all_scans %}
          {% for scan in all_scans %}
            <a href="#" class="list-group-item list-group-item-action bg-dark text-white">{{ scan.target_ip }} <small class="text-muted float-end">{{ scan.timestamp.split('T')[0] }}</small></a>
          {% endfor %}
        {% else %}
          <div class="list-group-item bg-dark text-white">No past scans found.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card bg-dark text-white mb-4">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span>Latest Scan Results</span>
        {% if latest_scan %}
        <a href="{{ url_for('generate_report') }}" class="btn btn-sm btn-outline-secondary">Download Report</a>
        {% endif %}
      </div>
      <div class="card-body">
        {% if latest_scan %}
          {% for host_ip, details in latest_scan.scan_details.items() %}
            <h5 class="card-title">Target: {{ host_ip }}</h5>
            <p class="mb-1"><strong class="text-muted">Hostname:</strong> {{ details.get('hostname', 'N/A') }}</p>
            <p><strong class="text-muted">OS Details:</strong> {{ details.get('os_details', 'N/A') }}</p>
            <hr>
            <h6>Open Ports</h6>
            <table class="table table-dark table-striped table-hover">
              <thead>
                <tr>
                  <th>Port</th>
                  <th>State</th>
                  <th>Service</th>
                  <th>Version</th>
                </tr>
              </thead>
              <tbody>
                {% for port, port_info in details.ports.items() if port_info.state == 'open' %}
                <tr>
                  <td><strong>{{ port }}</strong></td>
                  <td><span class="badge bg-success">{{ port_info.state }}</span></td>
                  <td>{{ port_info.get('name', 'N/A') }}</td>
                  <td>{{ port_info.get('version', 'N/A') }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" class="text-center">No open ports found.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endfor %}
        {% else %}
          <p class="text-center text-muted">No scan has been run yet. Start a new scan to see results.</p>
        {% endif %}
      </div>
    </div>

    <div class="card bg-dark text-white">
      <div class="card-header fw-bold text-primary">AI Threat Analysis</div>
      <div class="card-body">
        {% if analysis and (analysis.vulnerabilities or analysis.recommendations) %}
          {% if analysis.vulnerabilities %}
            <h6 class="text-danger">Potential Vulnerabilities</h6>
            <ul class="list-group list-group-flush mb-3">
              {% for vuln in analysis.vulnerabilities %}
                <li class="list-group-item bg-transparent text-white border-secondary">{{ vuln }}</li>
              {% endfor %}
            </ul>
          {% endif %}
          {% if analysis.recommendations %}
            <h6 class="text-info">Recommendations</h6>
            <ul class="list-group list-group-flush">
              {% for rec in analysis.recommendations %}
                <li class="list-group-item bg-transparent text-white border-secondary">{{ rec }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% else %}
          <p class="text-center text-muted">No analysis available. Run a scan to generate a report.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const scanForm = document.getElementById('scan-form');
    const scanStatus = document.getElementById('scan-status');
    const scanButton = document.getElementById('scan-button');

    scanForm.addEventListener('submit', function(event) {
        // 1. Prevent the default form submission which reloads the page
        event.preventDefault();

        // 2. Show a loading message and disable the button
        scanStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <strong>Scanning...</strong>
                <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
            </div>
        `;
        scanButton.disabled = true;

        // 3. Use the Fetch API to send the form data to the Flask backend
        fetch("{{ url_for('scan_network') }}", {
            method: 'POST',
            body: new FormData(scanForm)
        })
        .then(response => response.json())
        .then(data => {
            // 4. Handle the response from the server
            if (data.status === 'success') {
                scanStatus.innerHTML = '<div class="alert alert-success">Scan complete! Refreshing...</div>';
                // 5. Reload the page to show the new scan data
                setTimeout(() => {
                    window.location.reload();
                }, 1500); // Wait 1.5 seconds before reloading
            } else {
                // Show an error message if the scan failed
                scanStatus.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                scanButton.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            scanStatus.innerHTML = '<div class="alert alert-danger">An unexpected error occurred.</div>';
            scanButton.disabled = false;
        });
    });
});
</script>

{% endblock %}