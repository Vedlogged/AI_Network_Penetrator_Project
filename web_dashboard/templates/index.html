<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Network Penetrator Dashboard</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container my-5">
        <header class="text-center mb-5 animate__animated animate__fadeInDown">
            <h1 class="display-4 text-primary fw-bold">
                <i class="fas fa-shield-alt me-3"></i>AI Network Penetrator Dashboard
            </h1>
            <p class="lead text-muted">
                An intelligent system to identify vulnerabilities, analyze threats, and recommend solutions for robust network security.
            </p>
        </header>

        <section class="card shadow-lg mb-5 animate__animated animate__fadeInUp">
            <div class="card-header bg-gradient-primary text-white py-3">
                <h2 class="h4 mb-0"><i class="fas fa-search me-2"></i>Perform a Network Scan</h2>
            </div>
            <div class="card-body">
                <form id="scan-form">
                    <div class="mb-3">
                        <label for="target_ip" class="form-label fw-bold">Target IP/Hostname:</label>
                        <input type="text" id="target_ip" name="target_ip" class="form-control form-control-lg rounded-pill" value="127.0.0.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="ports_to_scan" class="form-label fw-bold">Ports to Scan (comma-separated, e.g., 22,80,443):</label>
                        <input type="text" id="ports_to_scan" name="ports_to_scan" class="form-control form-control-lg rounded-pill" value="21,22,23,80,443,8080">
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill animate__animated animate__pulse animate__infinite">
                        <i class="fas fa-play-circle me-2"></i>Start Scan
                    </button>
                </form>
                <div id="scan-status" class="mt-4 alert d-none text-center rounded-pill"></div>
                <div id="loading-spinner" class="text-center mt-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Scanning in progress...</p>
                </div>
            </div>
        </section>

        <section class="row">
            <div class="col-lg-7 mb-4 animate__animated animate__fadeInLeft">
                <div class="card shadow-lg h-100">
                    <div class="card-header bg-gradient-info text-white py-3">
                        <h2 class="h4 mb-0"><i class="fas fa-chart-line me-2"></i>Latest Scan Results</h2>
                    </div>
                    <div class="card-body" id="latest-scan-results">
                        <p class="text-muted">Perform a scan to see detailed results here.</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 mb-4 animate__animated animate__fadeInRight">
                <div class="card shadow-lg h-100">
                    <div class="card-header bg-gradient-warning text-dark py-3">
                        <h2 class="h4 mb-0"><i class="fas fa-chart-pie me-2"></i>Scan Summary Chart</h2>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="scanChart" class="w-100"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="card shadow-lg mb-5 animate__animated animate__fadeInUp">
            <div class="card-header bg-gradient-success text-white py-3">
                <h2 class="h4 mb-0"><i class="fas fa-brain me-2"></i>AI Threat Analysis & Recommendations</h2>
            </div>
            <div class="card-body" id="ai-analysis-results">
                <p class="text-muted">AI analysis will appear here after a scan.</p>
            </div>
        </section>

        <section class="card shadow-lg mb-5 animate__animated animate__fadeInUp">
            <div class="card-header bg-gradient-secondary text-white py-3">
                <h2 class="h4 mb-0"><i class="fas fa-history me-2"></i>Previous Scans</h2>
            </div>
            <div class="card-body" id="previous-scans-list">
                <p class="text-muted">Past scan records will be listed here.</p>
            </div>
        </section>

        <footer class="text-center mt-5 animate__animated animate__fadeInUp">
            <button id="download-report-btn" class="btn btn-success btn-lg rounded-pill animate__animated animate__bounceIn">
                <i class="fas fa-file-download me-2"></i>Download Latest Scan Report (CSV)
            </button>
            <p class="text-muted mt-3">&copy; 2025 AI Network Penetrator. All rights reserved.</p>
        </footer>

    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Animate.css CDN for subtle animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script>
        // Helper function to show/hide elements
        function toggleVisibility(elementId, show) {
            const element = document.getElementById(elementId);
            if (element) {
                if (show) {
                    element.classList.remove('d-none');
                } else {
                    element.classList.add('d-none');
                }
            }
        }

        // Function to display status messages
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('scan-status');
            statusDiv.textContent = message;
            statusDiv.className = `mt-4 alert alert-${type} text-center rounded-pill animate__animated animate__fadeIn`;
            toggleVisibility('scan-status', true);
        }

        // Function to hide status messages
        function hideStatus() {
            toggleVisibility('scan-status', false);
        }

        // Chart.js instance variable
        let scanChartInstance = null;

        // Event listener for the scan form submission
        document.getElementById('scan-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const targetIp = document.getElementById('target_ip').value;
            const portsToScan = document.getElementById('ports_to_scan').value;

            hideStatus();
            toggleVisibility('loading-spinner', true); // Show spinner

            try {
                const response = await fetch('/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `target_ip=${encodeURIComponent(targetIp)}&ports_to_scan=${encodeURIComponent(portsToScan)}`
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    showStatus('Scan completed successfully! Dashboard will update shortly.', 'success');
                    fetchLatestData(); // Refresh data after successful scan
                } else {
                    showStatus(`Error: ${data.message || 'Unknown error occurred.'}`, 'danger');
                }
            } catch (error) {
                console.error('Error during scan request:', error);
                showStatus('An unexpected error occurred while communicating with the server.', 'danger');
            } finally {
                toggleVisibility('loading-spinner', false); // Hide spinner
            }
        });

        // Function to fetch and update all dashboard data
        async function fetchLatestData() {
            try {
                const response = await fetch('/get_latest_data');
                const data = await response.json();

                const latestScanDiv = document.getElementById('latest-scan-results');
                const aiAnalysisDiv = document.getElementById('ai-analysis-results');
                const previousScansDiv = document.getElementById('previous-scans-list');
                const scanChartCanvas = document.getElementById('scanChart');

                // --- Update Latest Scan Results Section ---
                if (data.latest_scan && data.latest_scan.scan_details) {
                    const latestScan = data.latest_scan;
                    let latestScanHtml = `
                        <p class="mb-1"><strong>Scan ID:</strong> ${latestScan.scan_id}</p>
                        <p class="mb-1"><strong>Target IP:</strong> ${latestScan.target_ip}</p>
                        <p class="mb-3"><strong>Timestamp:</strong> ${latestScan.timestamp}</p>
                    `;

                    let openPortsCount = 0;
                    let totalPortsScanned = 0;

                    for (const host in latestScan.scan_details) {
                        const hostDetails = latestScan.scan_details[host];
                        latestScanHtml += `
                            <h3 class="mt-3 text-info"><i class="fas fa-desktop me-2"></i>Host: ${host}</h3>
                            <p class="mb-1"><strong>Hostname:</strong> ${hostDetails.hostname}</p>
                            <p class="mb-3"><strong>OS Details:</strong> ${hostDetails.os_details}</p>
                            <h4 class="mt-2 text-success"><i class="fas fa-door-open me-2"></i>Open Ports:</h4>
                            <ul class="list-group list-group-flush">
                        `;
                        if (Object.keys(hostDetails.ports).length > 0) {
                            totalPortsScanned = Object.keys(hostDetails.ports).length; // Assuming all listed ports were scanned
                            for (const port in hostDetails.ports) {
                                const portInfo = hostDetails.ports[port];
                                if (portInfo.state === 'open') {
                                    openPortsCount++;
                                    latestScanHtml += `
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><strong>Port ${port}</strong> - State: ${portInfo.state}</span>
                                            <span class="badge bg-primary rounded-pill">${portInfo.name} ${portInfo.version}</span>
                                        </li>
                                    `;
                                }
                            }
                        }
                        if (openPortsCount === 0) {
                            latestScanHtml += `<li class="list-group-item text-muted">No open ports found.</li>`;
                        }
                        latestScanHtml += `</ul>`;
                    }
                    latestScanDiv.innerHTML = latestScanHtml;

                    const closedPortsCount = totalPortsScanned - openPortsCount;

                    // Update chart data
                    if (scanChartInstance) {
                        scanChartInstance.destroy();
                    }

                    scanChartInstance = new Chart(scanChartCanvas, {
                        type: 'pie',
                        data: {
                            labels: ['Open Ports', 'Closed/Filtered Ports'],
                            datasets: [{
                                data: [openPortsCount, closedPortsCount],
                                backgroundColor: ['#28a745', '#dc3545'], // Green for open, Red for closed
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // Allow chart to fill container
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: '#333'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Port Scan Summary',
                                    color: '#0056b3',
                                    font: {
                                        size: 16
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += context.parsed;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    latestScanDiv.innerHTML = '<p class="text-muted">Perform a scan to see detailed results here.</p>';
                    if (scanChartInstance) {
                        scanChartInstance.destroy();
                        scanChartInstance = null;
                    }
                }

                // --- Update AI Analysis Section ---
                if (data.analysis && data.analysis.vulnerabilities.length > 0) {
                    let vulnerabilitiesHtml = '<h3 class="mt-3 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Potential Vulnerabilities:</h3><ul class="list-group list-group-flush">';
                    data.analysis.vulnerabilities.forEach(v => {
                        vulnerabilitiesHtml += `<li class="list-group-item list-group-item-danger">${v}</li>`;
                    });
                    vulnerabilitiesHtml += '</ul>';

                    let recommendationsHtml = '<h3 class="mt-3 text-success"><i class="fas fa-lightbulb me-2"></i>Recommendations:</h3><ul class="list-group list-group-flush">';
                    data.analysis.recommendations.forEach(r => {
                        recommendationsHtml += `<li class="list-group-item list-group-item-success">${r}</li>`;
                    });
                    recommendationsHtml += '</ul>';

                    aiAnalysisDiv.innerHTML = `
                        <p class="mb-2"><strong>AI Status:</strong> <span class="badge bg-info">${data.analysis.ai_status}</span></p>
                        ${vulnerabilitiesHtml}
                        ${recommendationsHtml}
                    `;
                } else {
                    aiAnalysisDiv.innerHTML = '<p class="text-muted">AI analysis will appear here after a scan.</p>';
                }

                // --- Update Previous Scans Section ---
                if (data.all_scans && data.all_scans.length > 0) {
                    let prevScansHtml = '<ul class="list-group">';
                    data.all_scans.forEach(scan => {
                        const scanStatusClass = scan.scan_details ? 'list-group-item-success' : 'list-group-item-danger';
                        prevScansHtml += `
                            <li class="list-group-item ${scanStatusClass} d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Scan ID:</strong> ${scan.scan_id} |
                                    <strong>Target:</strong> ${scan.target_ip}
                                </div>
                                <small class="text-muted">(${scan.timestamp})</small>
                            </li>
                        `;
                    });
                    prevScansHtml += '</ul>';
                    previousScansDiv.innerHTML = prevScansHtml;
                } else {
                    previousScansDiv.innerHTML = '<p class="text-muted">Past scan records will be listed here.</p>';
                }

            } catch (error) {
                console.error('Error fetching latest data:', error);
                showStatus('Error loading latest data. Check console for details.', 'danger');
            }
        }

        // Event listener for Download Report button
        document.getElementById('download-report-btn').addEventListener('click', async function() {
            showStatus('Generating report...', 'info');
            try {
                const response = await fetch('/generate_report');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'scan_report.csv';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    showStatus('Report downloaded successfully!', 'success');
                } else {
                    const errorText = await response.text();
                    showStatus(`Failed to generate report: ${errorText}`, 'danger');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                showStatus('An error occurred while generating the report.', 'danger');
            }
        });

        // Initial data fetch on page load
        document.addEventListener('DOMContentLoaded', fetchLatestData);
    </script>
</body>
</html>